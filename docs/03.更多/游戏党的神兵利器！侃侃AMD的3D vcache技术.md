#              游戏党的神兵利器！侃侃AMD的3d缓存技术

​        2022年1月4日，在lisa Su高调展示了带3d堆叠缓存的5900x样品的几个月后，amd终于在CES2022上发布了他们采用了全新3d堆叠技术的桌面处理器Ryzen7 5800X3D。

​        AMD在发布会上宣称5800X3D是世界上最快的游戏处理器。当然，实际上市后5800X3D的表现也确实对得起这个名号，达成了发布会上所说的超越12900k的游戏性能，甚至于到了现在还能跟ryzen7000和十三代酷睿在游戏性能上打的有来有回。那么，5800X3D到底是用了什么达成了如此丧心病狂的游戏性能捏？按照曾经评判cpu游戏性能的标准，一颗cpu的游戏性能主要是由它的核心频率，ipc以及核心数量来决定，但5800x3d却是个例外。看频率，比起5800X，5800X3D甚至降了一大截，从5800X的3.8GHZ-4.7GHZ降低至3.4GHZ-4.5GHZ；看ipc，一圈评测下来，ipc提升不到2%；看核心数，区区8c16t在对手的16c24t面前不能说旗鼓相当吧，只能说是被摁着打。但5800X3D的L3缓存容量，从5800x的32MB提升到了丧心病狂的96MB。这意味着，在zen3架构的缓存结构下，每个核心可以分到16MB-96MB的超大三缓。那么问题又来了，这巨大的三缓是如何提升了cpu的游戏性能呢？

​        **（来自LinusTechTips的游戏性能评测总结显示5800X3D相对12900k取得了7%的游戏性能优势）**

​        首先，我们还是得知道一些关于处理器缓存的基本常识，然后再开始我们的讨论。众所周知，电脑的内存，也就是RAM，它速度与CPU的速度相比慢的跟蜗牛一样，而且这个差距仍然在不断拉大。CPU每一次访问内存都需要等待几十上百个周期，而在这段时间里，CPU中的这条线程的处理效率就会受到较大影响，即使有乱序执行和超线程技术的帮助，仍会在流水线中产生不少空泡，降低效率。但是，这个问题并不是无解的。

​        解决办法一：把所有储存器都换成可以跟CPU速度保持同步的更快的储存器。这个方法对效率的提升最有利，但是由于高速储存器的成本极高，CPU整体的成本会飙升。所以这个办法至少在商业上不可行。

​        解决办法二：分级的缓存结构。这个方法兼顾了成本和性能，并一直被使用和改进至今。但是会比较复杂。大概就是：在cpu和ram之间插入一级或多级缓存，以当今cpu的缓存结构为例。在cpu和ram之间插入了总共3级缓存：L1 L2 L3。容量逐级递增，速度逐级递减。其中，L1缓存速度最快，能与CPU的速度保持同步，但容量最小，且被分割为L1D（储存数据）和L1I（储存指令）以尽量减少流水线冲突导致流水线空泡。其次是L2，L2缓存容量一般都能达到MB级，比L1缓存的几十KB高到不知道哪里去了，但是L2缓存的速度相比L1则要慢得多，L2的访问周期一般是10-20个周期，且从这一级开始，指令和数据不再被分开储存。再然后就是L3,L3缓存容量和结构就比较随意了。（以amd为例，zen1和zen+为每个核心2MB L3，zen2为每个核心4MB，zen3为每个核心4-32MB）速度上，L3比L2更慢，访问周期一般在50周期上下。

​        通过上文我们知道了现代处理器的缓存结构，但咱还得知道缓存结构是怎么工作的。假设CPU需要处理一个程序，那么它就需要访问储存器来得到它想要的数据，然后CPU就开始挨个问，先问L1：“老哥有无数据？”如果L1有，那CPU就直接从L1里取需要的数据去算。如果L1没有，那cpu就去问L2：“老哥有无数据？”如果L2有，那CPU就从L2里拿走需要的数据并等待10-20个周期，然后根据缓存一致性协议，用L2中包含需要数据的缓存块（也就是一堆数据）对L1中的缓存块根据替换算法进行替换。L3同理。如果l3还没有数据，那没办法，只能去RAM中拿数据，并老老实实对L1,L2,L3进行替换操作并等待几十上百周期。至于缓存一致性协议和替换策略在这篇文章里就不深究了。（有兴趣可以查阅相关书籍）

​       由于CPU处理的数据和指令一般是连续存放，所以再一次访存后，cpu一般都能享受到相当长一段时间在L1中存取数据的高效，用计算机术语说也就是缓存命中，在这段时间中CPU流水线会被填的更满，处理能力自然更高。从L1到L3，受容量提高和缓存替换策略影响，命中率逐渐提高，访问内存次数被大大减少，CPU大部分时间都在缓存内部拿数据进行处理，效率显著提高。即使发生了缓存miss，（也就是没命中）多级缓存结构也能显著减少访存周期。从而使CPU性能提高。

​       回到3D Vcache，其实说穿了就是amd用了3d堆叠封装技术，在CPU die上叠了一层或多层的缓存die，使CPU的三缓容量成倍提高，但是因为边际效应，实际命中率提升并没有像缓存容量提升幅度那么恐怖，所以总的IPC并没有太大提升。但是在一些专业和游戏领域，需要大量访问内存的情景中，AMD用3D Vcache技术硬堆的L3缓存就起到了大作用。比如游戏，CPU就可以将更多素材加载到L3中。减少，甚至避免访问内存，降低了CPU的访存延时，使CPU对内存频率的依赖降低，随之而来的便是游戏帧率的大幅度提高，以至于达到了换代级的15%的游戏性能提高。但是3D堆叠也有一定副作用，一个是因为L3容量极大提高，L3的访问周期也随之提高，但这点延时比起访问内存的延时来说确实不算啥。（部分对L3缓存延时敏感的项目的成绩会出现下滑）另一个则是初代3D缓存封装结构上的问题，导致5800X3D温度上升和对电压比较敏感，所以amd选择了降频+锁频来保证其正常运行。但是，据可靠消息，zen4 X3D使用了新结构的3D缓存，可以叠更多cache,且对电压的限制放宽，（这意味着zen4 X3D很可能会开放超频）再加上amd为了堆缓存，对zen4顶盖进行了加高处理。*~~（但这也导致了zen4普通版的温度暴增）~~*可以预见的是，zen4 X3D的性能会得到相比5800X3D之于5800X更大的提升，且频率很可能不会像5800X3D一样大幅度倒退，甚至于温度很可能可以持平甚至低于zen4普通版。

​        目前得到的消息以及路线图推测，amd会在2023年1月4日的CES2023上正式发布至少两款基于zen4 X3D的桌面产品，重新夺回游戏性能的王座。所以建议等等党再等等，或者直接intel yes！

​       